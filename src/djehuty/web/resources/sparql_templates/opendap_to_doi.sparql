{# Find the latest version of each article for which one of the conditions in
   the UNION clause holds and return some properties of these article versions.
   Filters restrict the values of ?data_url. #}
{% extends "prefixes.sparql" %}
{% block query %}
SELECT DISTINCT ?doi ?title
WHERE {
  GRAPH <{{state_graph}}> {
    ?article  a               djht:Article ;
              djht:container   ?container ;
              djht:version     ?version ;
              djht:title       ?title ;
              djht:doi         ?doi .
    {
      SELECT ?container (MAX(?i_version) AS ?version)
      WHERE {
        GRAPH <{{state_graph}}> {
          ?i_article  a               djht:Article ;
                      djht:container   ?container ;
                      djht:version     ?i_version .
          { ?i_article  djht:files/rdf:rest*/rdf:first  ?file .
            ?file       a                              djht:File ;
                        djht:is_link_only               true ;
                        djht:download_url               ?data_url . } UNION
          { ?i_article  djht:data_link                  ?data_url . }
        }
        {{ filters }}
      }
      GROUP BY ?container
    }
  }
}
{% endblock %}
